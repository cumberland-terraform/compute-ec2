// COMMENT: agent {} calls specific Jenkins container requested in label.
// COMMENT: Container ..ans216 below spec'd version by MDH DevOps Team.
// COMMENT: Container RHEL 8, Ansible 2.16, pip3.11, python 3.  It is the latest/greatest Jenkins MDT slave avail as of 6/14/2022
// COMMENT: environment {} calls Jenkins controller/pipeline config variables.
// COMMENT: Jenkins pipeline syntax - pipeline {agent{}environment{}stages{stage{steps{}}}}post{}} 
eter_compute_repo='https://mdt.global@source.mdthink.maryland.gov/scm/et/mdt-eter-aws-core-compute.git'

pipeline {
    agent { label 'ubuntu-jenkins_py311_ans216' }
    environment { EMAIL_TO = 'fn.ln@maryland.gov,fn.ln@maryland.gov' }
    stages {
        stage ('cleanWorkSpace') {
            steps { cleanWs() }
        }
        stage ('checkoutCode') {
            steps {
                checkout([
                    $class: 'GitSCM', 
                    branches: [[name: 'master']], 
                    doGenerateSubmoduleConfigurations: false, 
                    extensions: [], 
                    submoduleCfg: [], 
                    userRemoteConfigs: [[
                        credentialsId: '472b8d26-00b5-440a-b49c-f72d1cb1d798', 
                        url: eter_compute_repo
                    ]]
                ])
            }
        }
        // COMMENT: install any linux modules or additional ansible libraries here in stage (update tools)
        // COMMENT: sh with 3 single quotes runs linux shell on the Jenkins slave RHEL 8 server.
        // COMMENT: # is how to comment in linux shell
        stage ('update tools') {
            steps {
                sh'''
                # COMMENT: Example below installs TCPTrace in case you want to test connectivity issues with any entity
                # EXAMPLE: sudo apt-get install inetutils-traceroute
                # EXAMPLE: sudo apt-get install -y tcptraceroute
                '''
            }
        }
    }
    post {
        failure {
            emailext body: 'Check console output at $BUILD_URL to view the results. \n\n ${CHANGES} \n\n -------------------------------------------------- \n${BUILD_LOG_REGEX,regex="ERROR", escapeHtml=false}',
            to:   EMAIL_TO,
            subject: 'Build failed in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
        }
        success {
            emailext body: 'Check console output at $BUILD_URL to view the results.  \n\n ${CHANGES} \n\n -------------------------------------------------- \n${BUILD_LOG, maxLines=100, escapeHtml=false}',
            to:   EMAIL_TO,
            subject: 'Build succeeded in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
        }
        unstable {
            emailext body: 'Check console output at $BUILD_URL to view the results. \n\n ${CHANGES} \n\n -------------------------------------------------- \n${BUILD_LOG, maxLines=100, escapeHtml=false}',
            to:   EMAIL_TO,
            subject: 'Unstable build in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
        }
        changed {
            emailext body: 'Check console output at $BUILD_URL to view the results.',
            to:   EMAIL_TO,
            subject: 'Jenkins build is back to normal: $PROJECT_NAME - #$BUILD_NUMBER'
        }
    }
}
